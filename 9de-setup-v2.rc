#!/bin/rc
# 9DE quick setup for 9front (v2)
#
# Usage:
#   rc 9de-setup-v2.rc /path/to/9de_toolkit_v10.zip
#
# Does:
# - extracts repo to $home/src/9de (backs up old to 9de.old)
# - builds with mk
# - installs binaries + scripts to $home/bin
# - initializes $home/lib/9de/{defaults.rc,config.rc,autostart.rc}
# - wires rio startup via $home/bin/riostart wrapper (backs up existing to riostart.orig)
#
# Logs:
#   $home/lib/9de/log/setup.log
#   $home/lib/9de/log/setup.err

esc=`{awk 'BEGIN{printf("\033")}'}
blue=$esc^'[1;34m'
green=$esc^'[1;32m'
yellow=$esc^'[1;33m'
reset=$esc^'[0m'
logdir=$home/lib/9de/log
logfile=$logdir/setup.log
errfile=$logdir/setup.err

fn info {
    echo $blue^$*^$reset
}

fn success {
    echo $green^$*^$reset
}

fn die {
    echo $yellow^'9de-setup: '^$*^$reset >[1=2]
    exits 'fail'
}

fn mklogdir {
    mkdir -p $logdir
    mkdir -p $home/lib/9de/run
}

fn ensurepath {
    if(! ~ $path $home/bin){
        path=($home/bin $path)
        if(test -e $home/lib/profile){
            if(! grep -n 'home/bin' $home/lib/profile >/dev/null 2>&1){
                echo '' >> $home/lib/profile
                echo '# added by 9de-setup (for 9DE tools)' >> $home/lib/profile
                echo 'if(! ~ $path $home/bin) path=($home/bin $path)' >> $home/lib/profile
            }
        }
    }
}

fn have {
    if(which $1 >/dev/null 2>&1) echo 1
    if not echo 0
}

fn detectcc {
    o=$objtype
    if(~ $o '') o=amd64   # default on 9front/amd64
    switch($o){
    case amd64
        echo 6c
    case 386
        echo 8c
    case arm
        echo 5c
    case *
        echo 6c
    }
}

fn checkprereqs {
    info 'Checking prerequisites...'
    if(~ `{have mk} 0) die 'need mk (Plan 9 build tool) on $path'
    if(! test -e /sys/src/cmd/mklib) die 'missing /sys/src/cmd/mklib (install src tree)'

    cc=`{detectcc}
    if(~ `{have $cc} 0) die 'missing compiler: '^$cc^' (set objtype correctly?)'
    if(~ `{have unzip} 0) die 'need unzip(1). Install unzip or copy the repo tree by other means.'
}

fn installfile {
    src=$1
    dst=$2
    if(! test -e $src) die 'missing: '^$src
    rm -f $dst >/dev/null 2>&1
    cp $src $dst
}

fn backup {
    f=$1
    if(test -e $f){
        rm -f $f^.orig >/dev/null 2>&1
        mv $f $f^.orig
    }
}

zip=$1
if(~ $zip '') die 'usage: rc 9de-setup-v2.rc /path/to/9de_toolkit_v10.zip'
if(! test -e $zip) die 'zip not found: '^$zip

mklogdir
ensurepath
checkprereqs

mkdir -p $home/src
cd $home/src || die 'cannot cd to '^$home/src

# backup old
if(test -e $home/src/9de){
    rm -rf $home/src/9de.old >/dev/null 2>&1
    mv $home/src/9de $home/src/9de.old
}

# extract (zip contains "9de/...")
info 'Extracting 9DE archive ... (logs: '^$logfile^', '^$errfile^')'
unzip -o $zip >$logfile >[2]$errfile
if(! test -e $home/src/9de/mkfile) die 'extract failed; check '^$errfile

cd $home/src/9de || die 'cannot cd to repo'

# build
info 'Starting build ... (logs: '^$logfile^', '^$errfile^')'
mk >>$logfile >[2]$errfile
if(! test -e cmd/9de-panel/9de-panel) die 'build failed; check '^$errfile
success 'Build complete.'

# install to $home/bin
mkdir -p $home/bin

installfile cmd/9de-panel/9de-panel     $home/bin/9de-panel
installfile cmd/9de-shell/9de-shell     $home/bin/9de-shell
installfile cmd/9de-session/9de-session $home/bin/9de-session
installfile cmd/9de-control/9de-control $home/bin/9de-control
installfile cmd/9de-dash/9de-dash       $home/bin/9de-dash
installfile cmd/ui-demo/ui9demo         $home/bin/ui9demo

installfile bin/9de                     $home/bin/9de
installfile bin/9de-riostart            $home/bin/9de-riostart
installfile bin/9de-paneltest.rc        $home/bin/9de-paneltest.rc
installfile bin/9de-start.rc            $home/bin/9de-start.rc

chmod +x $home/bin/9de $home/bin/9de-riostart $home/bin/9de-paneltest.rc $home/bin/9de-start.rc >/dev/null 2>&1

# init + generate autostart
9de init  >>$logfile >[2]$errfile
9de gen   >>$logfile >[2]$errfile

# seed config with safe defaults if keys missing
cfg=$home/lib/9de/config.rc
if(test -e $cfg){
    if(! grep -n '^session_mode=' $cfg >/dev/null 2>&1) echo 'session_mode=normal' >> $cfg
    if(! grep -n '^test_layout=' $cfg >/dev/null 2>&1) echo 'test_layout=laptop' >> $cfg
    if(! grep -n '^ui_style=' $cfg >/dev/null 2>&1) echo 'ui_style=terminal' >> $cfg
    if(! grep -n '^ui_alpha=' $cfg >/dev/null 2>&1) echo 'ui_alpha=210' >> $cfg
    if(! grep -n '^ui_radius=' $cfg >/dev/null 2>&1) echo 'ui_radius=6' >> $cfg
}

# wire into rio startup (wrapper)
backup $home/bin/riostart
echo '#!/bin/rc' > $home/bin/riostart
echo '# generated by 9de-setup-v2. original saved as riostart.orig' >> $home/bin/riostart
echo 'if(which 9de-riostart >/dev/null 2>&1) 9de-riostart' >> $home/bin/riostart
echo 'if(test -e $home/bin/riostart.orig) . $home/bin/riostart.orig' >> $home/bin/riostart
chmod +x $home/bin/riostart >/dev/null 2>&1

echo ''
success 'Setup completed.'
echo '  repo:      '$home/src/9de
echo '  bin:       '$home/bin
echo '  config:    '$home/lib/9de/config.rc
echo '  logs:      '$logfile' + '$errfile
echo ''
echo 'Run now:'
echo '  9de start'
echo '  9de control'
echo 'Or restart rio / reboot for auto-start via '$home/bin/riostart
echo ''
exits ''
